# üßÆ Compteur Azure Functions avec Table Storage

Un compteur web persistant construit avec Azure Functions (Python) et Azure Table Storage. Ce projet d√©montre l'utilisation des services cloud Azure pour cr√©er une application web simple mais compl√®te.

https://learn.microsoft.com/en-us/azure/azure-functions/how-to-create-function-vs-code?pivots=programming-language-python

## üìã Table des mati√®res

- [Vue d'ensemble](#-vue-densemble)
- [Architecture](#-architecture)
- [Pr√©requis](#-pr√©requis)
- [Configuration locale](#-configuration-locale)
- [D√©veloppement local](#-d√©veloppement-local)
- [D√©ploiement Azure](#-d√©ploiement-azure)
- [Configuration Azure](#-configuration-azure)
- [Structure du projet](#-structure-du-projet)
- [D√©pannage](#-d√©pannage)
- [Bonnes pratiques](#-bonnes-pratiques)

## üéØ Vue d'ensemble

Cette application est un compteur web qui :
- ‚úÖ Affiche une interface web simple avec un compteur
- ‚úÖ Permet d'incr√©menter le compteur via un bouton
- ‚úÖ Stocke les donn√©es de mani√®re persistante dans Azure Table Storage
- ‚úÖ Fonctionne en local avec Azurite (√©mulateur) et en production avec Azure
- ‚úÖ Utilise une architecture serverless (Azure Functions)

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    Stockage    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  ‚îÇ                  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ ‚îÇ                 ‚îÇ
‚îÇ   Navigateur    ‚îÇ            ‚îÇ  Azure Function  ‚îÇ                ‚îÇ  Table Storage  ‚îÇ
‚îÇ   Web           ‚îÇ ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ     (Python)     ‚îÇ ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    HTML    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    Donn√©es     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Composants :

- **üåê Frontend :** HTML/CSS/JavaScript int√©gr√© dans la r√©ponse HTTP
- **‚ö° Backend :** Azure Functions (Python 3.12+)
- **üóÑÔ∏è Base de donn√©es :** Azure Table Storage (NoSQL)
- **üîß D√©veloppement local :** Azurite (√©mulateur Azure Storage)

### Flux de donn√©es :

1. **GET** `/api/counter` ‚Üí Affiche l'interface web avec le compteur actuel
2. **POST** `/api/counter` ‚Üí Incr√©mente le compteur et retourne la nouvelle valeur
3. **Storage** ‚Üí Les donn√©es sont stock√©es dans la table `counterdata`

## üì¶ Pr√©requis

### Outils requis :

- **Python 3.12+** ([t√©l√©charger](https://python.org))
- **Node.js** ([t√©l√©charger](https://nodejs.org)) pour Azurite
- **Azure Functions Core Tools** ([installation](https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local))
- **uv** (gestionnaire de packages Python) ([installation](https://docs.astral.sh/uv/))
- **VS Code** avec l'extension Azure Functions (recommand√©)

### Installation sur macOS :

```bash
# Homebrew
brew install python node azure-functions-core-tools

# uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Azurite (√©mulateur Azure Storage)
npm install -g azurite
```

### Compte Azure :

- Compte Azure actif ([inscription gratuite](https://azure.microsoft.com/free/))
- Azure CLI install√© et configur√©

## üñ•Ô∏è Configuration locale

### 1. Cloner et configurer le projet

```bash
# Cr√©er l'environnement virtuel
uv venv
source .venv/bin/activate  # macOS/Linux

# Installer les d√©pendances
uv pip install azure-functions azure-data-tables
uv pip freeze > requirements.txt
```

### 2. Structure des fichiers

```
azure_function/
‚îú‚îÄ‚îÄ .venv/                     # Environnement virtuel Python
‚îú‚îÄ‚îÄ .azurite/                  # Donn√©es Azurite (ignor√© par git)
‚îú‚îÄ‚îÄ .vscode/
‚îÇ   ‚îî‚îÄ‚îÄ tasks.json            # Configuration VS Code
‚îú‚îÄ‚îÄ function_app.py           # Code principal de la fonction
‚îú‚îÄ‚îÄ requirements.txt          # D√©pendances Python
‚îú‚îÄ‚îÄ host.json                 # Configuration Azure Functions
‚îú‚îÄ‚îÄ local.settings.json       # Configuration locale
‚îú‚îÄ‚îÄ .funcignore              # Exclusions pour le d√©ploiement
‚îî‚îÄ‚îÄ .gitignore               # Exclusions Git
```

### 3. Configuration locale (`local.settings.json`)

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "python"
  }
}
```

### 4. Configuration VS Code (`.vscode/tasks.json`)

```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "azurite: start",
      "type": "shell",
      "command": "azurite",
      "args": ["--silent", "--location", "${workspaceFolder}/.azurite"],
      "isBackground": true,
      "problemMatcher": []
    },
    {
      "type": "func",
      "label": "func: host start",
      "command": "host start",
      "problemMatcher": "$func-python-watch",
      "isBackground": true,
      "dependsOn": ["azurite: start", "pip install (functions)"]
    },
    {
      "label": "pip install (functions)",
      "type": "shell",
      "command": "uv pip install -r requirements.txt",
      "options": {
        "cwd": "${workspaceFolder}",
        "env": {"VIRTUAL_ENV": "${workspaceFolder}/.venv"}
      }
    }
  ]
}
```

## üöÄ D√©veloppement local

### D√©marrage automatique (VS Code)

1. **F5** ou "Start Debugging" ‚Üí Lance automatiquement Azurite (la fonction faut la d√©marrer a la main avec func start --verbose, TODO: modifier la config)
2. Acc√©der √† `http://localhost:7071/api/counter`

### D√©marrage manuel

```bash
# Terminal 1 : D√©marrer Azurite
azurite --silent --location .azurite

# Terminal 2 : D√©marrer la fonction
source .venv/bin/activate
func start --verbose
```

### V√©rification du fonctionnement

1. **Interface web :** `http://localhost:7071/api/counter`
2. **Logs :** Visibles dans le terminal func start
3. **Donn√©es :** Tables visibles dans Azure Storage Explorer (connect√© √† l'√©mulateur)

## ‚òÅÔ∏è D√©ploiement Azure

### 1. Pr√©paration du d√©ploiement

Assurer que `.funcignore` exclut les fichiers inutiles :

```
.azurite/
__pycache__/
.venv/
local.settings.json
.vscode/
.git/
.DS_Store
```

### 2. M√©thodes de d√©ploiement

#### VS Code

1. **F1** ‚Üí "Azure Functions: Deploy to Function App..."
2. **"Create new Function App in Azure..."**
3. S√©lectionner :
   - **Nom :** unique (ex: `massacreur_de_vulves`)
   - **Runtime :** Python 3.12
   - **R√©gion :** West Europe

## ‚öôÔ∏è Configuration Azure

### Ressources cr√©√©es automatiquement

- **üì¶ Function App :** Ex√©cute votre code Python
- **üóÑÔ∏è Storage Account :** Stocke les donn√©es du compteur
- **üìä Application Insights :** Monitoring et logs
- **‚ö° App Service Plan :** Ressources de calcul (plan Consumption)

### Configuration du Storage

#### Probl√®me courant : Authentification par cl√© d√©sactiv√©e

**Erreur :** `KeyBasedAuthenticationNotPermitted`

**Solution :**
1. **Storage Account** ‚Üí **Settings** ‚Üí **Configuration**
2. **"Allow storage account key access"** ‚Üí **Enabled**
3. **Save**

#### Configuration de la connection string

1. **Function App** ‚Üí **Settings** ‚Üí **Environment variables**
2. **Ajouter** `AzureWebJobsStorage` si manquant :
   - **Name :** `AzureWebJobsStorage`
   - **Value :** Connection string du Storage Account

**R√©cup√©rer la connection string :**
1. **Storage Account** ‚Üí **Security + networking** ‚Üí **Access keys**
2. **key1** ‚Üí **Show** ‚Üí **Copier "Connection string"**

### V√©rification du fonctionnement

#### URLs importantes

- **üåê Application :** `https://[votre-app].azurewebsites.net/api/counter?code=...`
- **üìä Monitoring :** Portail Azure ‚Üí Function App ‚Üí Monitoring
- **üóÑÔ∏è Donn√©es :** Portail Azure ‚Üí Storage Account ‚Üí Tables ‚Üí `counterdata`

#### Surveillance

- **Logs en temps r√©el :** Function App ‚Üí Log stream
- **M√©triques :** Function App ‚Üí Metrics
- **Erreurs :** Application Insights ‚Üí Failures

## üìÅ Structure du projet

### Fichiers principaux

#### `function_app.py`

```python
import azure.functions as func
import logging
import json
import os
from azure.data.tables import TableServiceClient, TableEntity

app = func.FunctionApp(http_auth_level=func.AuthLevel.FUNCTION)

# Configuration
STORAGE_CONNECTION_STRING = os.environ.get('AzureWebJobsStorage')
TABLE_NAME = 'counterdata'

# Fonctions de gestion du storage...
```

#### `requirements.txt`

```
azure-functions
azure-data-tables
```

#### `host.json`

```json
{
  "version": "2.0",
  "functionTimeout": "00:05:00",
  "extensions": {
    "http": {
      "routePrefix": "api"
    }
  }
}
```

### Donn√©es stock√©es

**Table :** `counterdata`
**Structure :**

| PartitionKey | RowKey | count | Timestamp |
|--------------|--------|--------|-----------|
| counter      | main   | 42     | 2025-09-11... |

## üõ†Ô∏è D√©pannage

### Probl√®mes courants

#### 1. Erreur 500 lors du clic sur le bouton

**Sympt√¥mes :** Page s'affiche, mais le compteur ne s'incr√©mente pas

**Causes possibles :**
- Configuration Storage manquante
- Permissions insuffisantes
- Authentification par cl√© d√©sactiv√©e

**Solutions :**
1. V√©rifier les logs : Function App ‚Üí Log stream
2. V√©rifier `AzureWebJobsStorage` dans Environment variables
3. Activer l'authentification par cl√© dans le Storage Account

#### 2. Module 'azure.data.tables' not found

**Cause :** D√©pendances non install√©es lors du d√©ploiement

**Solution :**
```bash
# V√©rifier requirements.txt
cat requirements.txt

# Red√©ployer
func azure functionapp publish [votre-app]
```

#### 3. Azurite ne d√©marre pas en local

**Sympt√¥mes :** `EADDRINUSE` ou ports occup√©s

**Solutions :**
```bash
# Tuer les processus Azurite
pkill -f azurite

# Changer les ports
azurite --blobPort 10001 --queuePort 10002 --tablePort 10003
```

#### 4. VS Code ne trouve pas la fonction

**Cause :** `.venv` inclus dans le d√©ploiement

**Solution :**
```bash
# Nettoyer
rm -rf __pycache__ .azurite .venv

# V√©rifier .funcignore
echo ".venv/" >> .funcignore

# Red√©ployer
```

### Logs et monitoring

#### Commandes utiles

```bash
# Logs en temps r√©el
func azure functionapp logstream [votre-app]

# Status de l'app
az functionapp show --name [votre-app] --resource-group [votre-rg]

# Red√©marrer l'app
az functionapp restart --name [votre-app] --resource-group [votre-rg]
```

#### Logs d√©taill√©s

Dans Azure :
1. **Function App** ‚Üí **Functions** ‚Üí **counter_function** ‚Üí **Monitor**
2. **Application Insights** ‚Üí **Live Metrics**
3. **Storage Account** ‚Üí **Monitoring** ‚Üí **Insights**

## üéØ Bonnes pratiques

### S√©curit√©

- ‚úÖ Utiliser Managed Identity au lieu de connection strings
- ‚úÖ Activer HTTPS uniquement
- ‚úÖ Restreindre les Function Keys
- ‚úÖ Surveiller les acc√®s avec Application Insights

### Performance

- ‚úÖ Utiliser le plan Consumption pour les charges l√©g√®res
- ‚úÖ Optimiser les requ√™tes Table Storage (PartitionKey/RowKey)
- ‚úÖ Impl√©menter une logique de retry pour les erreurs transitoires
- ‚úÖ Surveiller les m√©triques de performance

### D√©veloppement

- ‚úÖ Tester localement avec Azurite avant d√©ploiement
- ‚úÖ Utiliser des environnements s√©par√©s (dev/staging/prod)
- ‚úÖ Versioning du code avec Git
- ‚úÖ CI/CD avec GitHub Actions ou Azure DevOps

### Co√ªts

- üìä **Function App :** 1M ex√©cutions gratuites/mois
- üíæ **Storage :** ~0.01‚Ç¨/mois pour usage typique
- üìà **Application Insights :** Premiers 5GB gratuits/mois

**Total estim√© :** Pratiquement gratuit pour usage personnel

### √âvolutions possibles

- üîê **Authentification :** Ajouter login utilisateur
- üì± **Mobile :** Application mobile avec Azure Mobile Apps
- üåê **API :** Exposer une API REST compl√®te
- üìä **Analytics :** Tableau de bord avec Azure Dashboard
- üîÑ **CI/CD :** D√©ploiement automatique depuis Git

## üìö Ressources suppl√©mentaires

- [Documentation Azure Functions](https://docs.microsoft.com/azure/azure-functions/)
- [Azure Table Storage SDK](https://docs.microsoft.com/azure/storage/tables/)
- [VS Code Azure Functions Extension](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)
- [Azure Free Account](https://azure.microsoft.com/free/)

---

**Auteur :** Nick Guer
**Version :** 1.0
**Derni√®re mise √† jour :** Septembre 2025

üí° **Astuce :** N'h√©sitez pas √† exp√©rimenter et modifier le code pour apprendre ! Azure offre de nombreux services qui peuvent enrichir cette application de base.