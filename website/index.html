<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur S√©curis√© - Entra ID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîê</text></svg>">
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 1.5s infinite; }
        
        @keyframes counterUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .counter-animate { animation: counterUpdate 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
        
        <!-- Section Authentification -->
        <div id="auth-section" class="bg-white rounded-lg shadow-lg p-6 mb-4">
            <!-- √âtat de connexion g√©r√© par JavaScript -->
            <div id="login-screen" class="text-center hidden">
                <div class="mb-4">
                    <div class="text-6xl mb-4">üîê</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Authentification requise</h2>
                    <p class="text-gray-600 mb-6">Connectez-vous avec votre compte Entra ID pour acc√©der au compteur s√©curis√©</p>
                </div>
                <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                    Se connecter avec Entra ID
                </button>
            </div>

            <div id="user-info" class="hidden">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            <span id="user-initial">?</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Connect√© en tant que</p>
                            <p class="font-semibold text-gray-800" id="user-name">-</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                        D√©connexion
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenu principal de l'application -->
        <div id="app-content" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                
                <!-- Header -->
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üîê Compteur S√©curis√©</h1>
                    <p class="text-gray-600 text-sm">Authentifi√© avec Microsoft Entra ID (MSAL.js)</p>
                </div>

                <!-- Affichage du compteur -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-8 text-center mb-6 shadow-lg">
                    <div id="counter-value" class="text-6xl font-bold text-white loading">-</div>
                </div>

                <!-- Boutons d'action -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="updateCounter('increment')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        ‚ûï +1
                    </button>
                    <button onclick="updateCounter('decrement')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        ‚ûñ -1
                    </button>
                    <button onclick="updateCounter('reset')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        üîÑ Reset
                    </button>
                </div>

                <!-- Toast de notification -->
                <div id="toast" class="hidden mb-4 p-3 rounded-lg text-white text-center font-medium"></div>

                <!-- Informations -->
                <div class="border-t border-gray-200 pt-4 space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Derni√®re mise √† jour:</span>
                        <span id="last-updated" class="font-medium text-gray-800">-</span>
                    </div>
                    <div id="last-user-section" class="hidden bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Modifi√© par:</span>
                            <span id="last-user" class="font-medium text-gray-800">-</span>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center mt-6 text-xs text-gray-500">
                    <p>Compteur s√©curis√© avec Azure Functions + Entra ID</p>
                    <p class="mt-1">MSAL.js v2 ‚Ä¢ OAuth 2.0 / OpenID Connect</p>
                </div>
            </div>
        </div>

        <!-- Indicateur de chargement initial -->
        <div id="loading-screen" class="bg-white rounded-lg shadow-lg p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-600">Initialisation de l'authentification...</p>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION MSAL (√Ä ADAPTER)
        // ========================================
        const msalConfig = {
            auth: {
                clientId: "COUNTER_CLIENT_ID",
                authority: "https://login.microsoftonline.com/COUNTER_TENANT_ID",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const loginRequest = {
            scopes: ["api://COUNTER_CLIENT_ID/user_impersonation"]
        };

        const API_URL = 'COUNTER_API_URL/api/counter';

        let currentAccount = null;

        // ========================================
        // INITIALISATION
        // ========================================
        async function initialize() {
            console.log('üöÄ Initialisation MSAL...');
            
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    currentAccount = response.account;
                    console.log('‚úÖ Authentification r√©ussie apr√®s redirection');
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        console.log('‚úÖ Compte trouv√© dans le cache');
                    }
                }

                document.getElementById('loading-screen').classList.add('hidden');
                
                if (currentAccount) {
                    showAuthenticatedView();
                    await loadCounter();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation:', error);
                document.getElementById('loading-screen').classList.add('hidden');
                showLoginScreen();
            }
        }

        // ========================================
        // AUTHENTIFICATION
        // ========================================
        async function login() {
            console.log('üîë D√©marrage de l\'authentification...');
            try {
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error('‚ùå Erreur de connexion:', error);
                showToast('Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                console.log('üëã D√©connexion...');
                await msalInstance.logoutRedirect({
                    account: currentAccount
                });
            }
        }

        async function getAccessToken() {
            const request = {
                ...loginRequest,
                account: currentAccount
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                console.warn('‚ö†Ô∏è Token silent failed, redirection n√©cessaire');
                await msalInstance.acquireTokenRedirect(request);
            }
        }

        // ========================================
        // UI
        // ========================================
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
        }

        function showAuthenticatedView() {
            const userName = currentAccount.name || currentAccount.username;
            const initial = userName.charAt(0).toUpperCase();
            
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-initial').textContent = initial;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('app-content').classList.remove('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `p-3 rounded-lg text-white text-center font-medium mb-4 ${colors[type]}`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ========================================
        // API CALLS
        // ========================================
        async function loadCounter() {
            try {
                console.log('üì• Chargement du compteur...');
                const counterEl = document.getElementById('counter-value');
                counterEl.textContent = '...';
                counterEl.classList.add('loading');

                const token = await getAccessToken();
                
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Donn√©es re√ßues:', data);

                counterEl.classList.remove('loading');
                counterEl.textContent = data.value;
                counterEl.classList.add('counter-animate');
                setTimeout(() => counterEl.classList.remove('counter-animate'), 300);

                if (data.last_updated) {
                    const date = new Date(data.last_updated);
                    document.getElementById('last-updated').textContent = date.toLocaleString('fr-FR');
                }

                if (data.last_user) {
                    document.getElementById('last-user').textContent = data.last_user;
                    document.getElementById('last-user-section').classList.remove('hidden');
                }

            } catch (error) {
                console.error('‚ùå Erreur de chargement:', error);
                document.getElementById('counter-value').textContent = '‚ùå';
                document.getElementById('counter-value').classList.remove('loading');
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function updateCounter(action) {
            try {
                console.log(`üîÑ Action "${action}"...`);
                
                document.querySelectorAll('button').forEach(btn => btn.disabled = true);

                const token = await getAccessToken();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Action r√©ussie:', data);

                const messages = {
                    increment: '‚ûï Compteur incr√©ment√©',
                    decrement: '‚ûñ Compteur d√©cr√©ment√©',
                    reset: 'üîÑ Compteur r√©initialis√©'
                };
                showToast(messages[action], 'success');

                await loadCounter();

            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showToast('Erreur: ' + error.message, 'error');
            } finally {
                document.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }

        // ========================================
        // √âV√âNEMENTS
        // ========================================
        window.addEventListener('load', initialize);

        setInterval(() => {
            if (currentAccount && !document.hidden) {
                console.log('üîÑ Rafra√Æchissement auto...');
                loadCounter();
            }
        }, 30000);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentAccount) {
                loadCounter();
            }
        });
    </script>
</body>
</html>